@page "/"//errorboard
@using DevelopmentProjectErrorBoardUI.Services
@using DevelopmentProjectErrorBoardUI.Models
@using DevelopmentProjectErrorBoardUI.Enums
@using System.ComponentModel
@using System.Text.Json
@using DevelopmentProjectErrorBoardUI.Services.Interfaces
@inject IErrorService ErrorService
@inject IJSRuntime JSRuntime

<PageTitle>Error Monitor</PageTitle>

@if (!IsLoggedIn)
{
    <LoginPopup />
}
else
{
    @if (errors == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <h2>Errors</h2>

        @if (errors.Count == 0)
        {
            <h2>
                No errors to resolve at this time
            </h2>
        }
        else
        {
            <table class="table">
                <thead>
                <tr>
                    <th></th>
                    <th>File</th>
                    <th>Line</th>
                    <th>Agent Id</th>
                    <th>Developer</th>
                    <th>Status</th>
                    <th>Delete</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var error in errors)
                {
                    <tr>
                        <button @onclick="() => ToggleExpand(error.Error.ErrorId)" id="dropDownArrow">
                            @if (expandedStates.TryGetValue(error.Error.ErrorId, out var expanded) && expanded)
                            {
                                <img src="up_arrow.png" alt="Button Image"/>
                            }
                            else
                            {
                                <img src="down_arrow.png" alt="Button Image"/>
                            }
                            
                        </button>
                        <td>@error.Error.InitialFile</td>
                        <td>@error.Error.LineNumber</td>
                        <td>@error.Error.AgentId</td>
                        @*@if (error.Error.DeveloperId == null)
                         {
                             <td>Unassigned</td>
                         }
                        else
                        {
                           <td>@error.Error.DeveloperId</td> 
                        }*@
                        <td> 
                            <select 
                                value="@(error.Error.DeveloperId ?? 1)" 
                                class="select-element"
                                    @onchange="@(args => updateDeveloper(error.Error.ErrorId, args.Value.ToString()))">
                                @foreach (var dev in developers)
                                {
                                    <option value="@dev.UserId">@dev.FirstName @(dev.UserId == 1 ? "" : "."+dev.LastName[0])</option>
                                }
                            </select>
                        </td>
                        <td>
                            <select value="@((StatusEnum)error.Error.StatusId)" class="select-element"
                                    @onchange="@(args => updateError(new UpdateErrorStatusModel { ErrorId = error.Error.ErrorId, StatusId = (int)(StatusEnum)Enum.Parse(typeof(StatusEnum), args.Value.ToString()), AgentId = error.Error.AgentId, CustomerId = error.Error.CustomerId, DevId = devId /*error.Error.DeveloperId */ }))">
                                @foreach (var st in statuses)
                                {
                                    <option value="@st">@GetEnumDescription(st)</option>
                                }
                            </select>
                        </td>
                        <td> <button @onclick="() => removeError(error.Error.ErrorId)">Remove</button> </td>

                    </tr>
                   
                    @if(expandedStates.TryGetValue(error.Error.ErrorId, out var isExpanded) && isExpanded)
                    {
                        @foreach (var path in error.LogPaths)
                        {
                            <tr>
                                <td></td>
                                <td>@path.FileName</td>
                                <td>@path.CreatedDate</td>
                            </tr>
                        }
                    }
                }
                </tbody>
            </table>
        }
    }
}

@code {
    
    List<StatusEnum> statuses = Enum.GetValues(typeof(StatusEnum)).Cast<StatusEnum>().ToList();
   List<ErrorAndPathModel> errors;
   List<UserModel> developers;
   bool IsLoggedIn { get; set; }
   int devId { get; set; }
   
   private Dictionary<int, bool> expandedStates = new();
   
    protected override async Task OnInitializedAsync()
    {
        var isLoggedInJson = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "loggedIn");
        if (!string.IsNullOrEmpty(isLoggedInJson))
        {
            IsLoggedIn = JsonSerializer.Deserialize<bool>(isLoggedInJson);
        }
    
        if (IsLoggedIn)
        {
            devId = JsonSerializer.Deserialize<int>(await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "userId"));
            
            errors = await ErrorService.GetAllErrorsAsync();

            developers = await ErrorService.GetDevelopersAsync();

            foreach (var u in developers)
            {
                Console.WriteLine(u.EmailAddress);
            }
            
            foreach (var er in errors)
            {
                ToggleExpand(er.Error.ErrorId);
            }
            
            Console.WriteLine(statuses);
        }
        
       Console.WriteLine(statuses);
    }

    void removeError(int errorId )
    {
        Console.WriteLine($"Error Id {errorId} has been removed");
    }
    
    async Task updateError(UpdateErrorStatusModel model)
    {
        errors = await ErrorService.UpdateErrorStatusAsync(model);
    }
    
    async Task updateDeveloper( int errorId, string devId)
    {
        errors = await ErrorService.UpdateErrorsAssignedDeveloperAsync(new UpdateErrorsAssignedDeveloperModel{ErrorId =errorId, DevId = Convert.ToInt32(devId)});
        Console.WriteLine($"update dev called with errorId {errorId} and devId {devId}");
    }
    
    static string GetEnumDescription(Enum value)
    {
        var field = value.GetType().GetField(value.ToString());
        var attribute = (DescriptionAttribute)Attribute.GetCustomAttribute(field, typeof(DescriptionAttribute));
        return attribute == null ? value.ToString() : attribute.Description;
    }
    
    private void ToggleExpand(int errorId)
    {
        if (expandedStates.ContainsKey(errorId))
        {
            expandedStates[errorId] = !expandedStates[errorId];
        }
        else
        {
            expandedStates.Add(errorId, true);
        }
    }
}

@*reference 
https://stackoverflow.com/questions/12169443/get-dictionary-value-by-key*@